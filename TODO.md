# 未実装機能リスト

## 📋 実装状況サマリー

### ✅ 実装済み機能

1. **講義コード入力画面**
   - 講義コードで入室
   - バリデーションとエラーハンドリング

2. **投稿機能**
   - 匿名投稿（最大200文字）
   - 文字数カウンター
   - リアルタイム反映

3. **タイムライン表示**
   - カード形式で投稿を表示
   - 投稿時間の相対表示
   - 削除された投稿の非表示

4. **リアルタイム同期**
   - Supabase Realtimeで新規投稿を自動反映
   - いいね数のリアルタイム更新

5. **いいね機能**
   - いいねボタン（1人1回制限）
   - LocalStorageベースのユーザー識別
   - リアルタイムカウントアップ

6. **ソート機能**
   - 新着順/人気順の切り替え
   - いいね数更新時の自動再ソート

7. **講義終了トリガー（部分実装）**
   - 終了時刻+15分まで投稿可能
   - 手動終了API（`POST /api/lectures/[id]/end`）
   - 講義状態の定期確認（30秒ごと）
   - 投稿フォームの無効化

---

## ❌ 未実装機能

### 1. Phase 3: AI要約機能（最優先）

**概要:** 講義終了後のAI要約生成と生データの物理削除

**実装が必要な機能:**

#### 1.1 AI要約生成API
- **エンドポイント:** `POST /api/lectures/[id]/summarize`
- **機能:**
  - 講義の全投稿データを取得
  - OpenAI API（`gpt-4o-mini`）に送信
  - 「主要な論点」「学生の関心事項」を要約
  - `summaries`テーブルに保存
- **必要な情報:**
  - 投稿内容のリスト
  - いいね数の統計
  - 投稿総数

#### 1.2 生データの物理削除 ✅ **実装済み**
- **機能:**
  - `posts`テーブルから該当講義の投稿を削除（`DELETE`文）
  - `likes`テーブルから該当講義のいいねを削除（`DELETE`文）
  - `lectures.status`を`'summarized'`に更新
- **注意:** 復元不可能にするため、`deleted_at`ではなく物理削除
- **実装ファイル:** `app/api/lectures/[id]/delete-data/route.ts`
- **ドキュメント:** `docs/DELETE_DATA_API.md`

#### 1.3 Vercel Cronジョブ
- **機能:**
  - 定期的に`status = 'ended'`の講義をチェック
  - 講義終了から一定時間（例：1時間）経過後、自動的に要約処理を実行
- **設定:**
  - `vercel.json`にCronジョブを定義
  - または`app/api/cron/summarize-lectures/route.ts`を作成

#### 1.4 要約表示画面
- **機能:**
  - 講義終了後、要約を表示する画面
  - `summaries`テーブルから要約を取得
  - 統計情報（投稿総数、いいね総数）を表示

**参考ファイル:**
- `schema.sql` - `summaries`テーブルの定義
- `lib/supabase/server.ts` - Service Role Keyを使用したSupabaseクライアント

---

### 2. 自動終了トリガー

**概要:** 講義終了時刻をチェックして自動的に`status = 'ended'`に変更

**実装が必要な機能:**

#### 2.1 自動終了チェックAPI
- **エンドポイント:** `POST /api/cron/check-lecture-end` または Vercel Cron
- **機能:**
  - `status = 'active'`の講義を取得
  - `scheduled_end_time`をチェック
  - 終了時刻を過ぎていたら`status = 'ended'`に更新
- **実行頻度:** 5分ごと（Vercel Cron）

**現在の状態:**
- 手動終了API（`POST /api/lectures/[id]/end`）は実装済み
- 自動終了は未実装

---

### 3. 荒らし対策（レートリミット）

**概要:** 連投制限など、荒らし行為を防ぐ機能

**実装が必要な機能:**

#### 3.1 投稿レートリミット
- **機能:**
  - 同一ユーザー（LocalStorage UUID）からの連投制限
  - 例：1分間に3回まで、または10秒に1回まで
- **実装場所:**
  - `app/api/posts/route.ts`にレートリミットロジックを追加
  - メモリベース（Map）またはRedis（本番環境）

#### 3.2 いいねレートリミット
- **機能:**
  - 同一ユーザーからの連続いいね制限
  - 例：1秒に1回まで
- **実装場所:**
  - `app/api/likes/route.ts`にレートリミットロジックを追加

**参考:**
- PRDでは「必要に応じてAPIルートのレートリミットで対応」と記載

---

### 4. UI/UXの改善

**概要:** ユーザー体験を向上させる機能

**実装が必要な機能:**

#### 4.1 講義情報の表示
- **機能:**
  - 講義ページに講義名、回数を表示
  - 講義コード、タイトルをヘッダーに表示
- **実装場所:**
  - `app/lecture/[id]/page.tsx`に講義情報を取得・表示

#### 4.2 エラーハンドリングの改善
- **機能:**
  - より分かりやすいエラーメッセージ
  - ネットワークエラー時のリトライ機能
  - オフライン時の通知

#### 4.3 ローディング状態の改善
- **機能:**
  - スケルトンローディング
  - より分かりやすいローディング表示

#### 4.4 要約表示画面
- **機能:**
  - 講義終了後、要約を表示する専用画面
  - `app/lecture/[id]/summary/page.tsx`を作成
  - 統計情報の可視化

---

### 5. その他の改善

#### 5.1 テスト
- **単体テスト**
  - APIルートのテスト
  - ユーティリティ関数のテスト
- **統合テスト**
  - エンドツーエンドのテスト
  - リアルタイム同期のテスト

#### 5.2 パフォーマンス最適化
- **機能:**
  - 投稿一覧のページネーション（必要に応じて）
  - 画像最適化（将来の機能拡張時）

#### 5.3 アクセシビリティ
- **機能:**
  - キーボードナビゲーション
  - スクリーンリーダー対応
  - ARIA属性の追加

---

## 🎯 実装優先順位

### 高優先度
1. **Phase 3: AI要約機能** - プロダクトの核心機能
2. **自動終了トリガー** - 運用に必須
3. **荒らし対策（レートリミット）** - セキュリティ・品質に重要

### 中優先度
4. **講義情報の表示** - UX向上
5. **要約表示画面** - Phase 3と連携

### 低優先度
6. **エラーハンドリングの改善** - 既存機能の改善
7. **ローディング状態の改善** - UX向上
8. **テスト** - 品質保証

---

## 📝 実装時の注意事項

### Phase 3実装時の注意点
- OpenAI APIのコストを考慮（`gpt-4o-mini`を使用）
- 大量の投稿がある場合のトークン制限に注意
- 物理削除は不可逆的な操作のため、慎重に実装
- エラーハンドリングを徹底（要約生成失敗時の処理）

### レートリミット実装時の注意点
- 開発環境では緩い制限を設定
- 本番環境では適切な制限を設定
- ユーザーに分かりやすいエラーメッセージを表示

### Vercel Cron実装時の注意点
- Vercel HobbyプランではCronジョブの実行頻度に制限あり
- タイムアウトに注意（Serverless Functionsの制限）
- エラーログの監視

---

## 🔗 関連ファイル

- `schema.sql` - データベーススキーマ（`summaries`テーブル定義）
- `lib/supabase/server.ts` - Service Role Keyを使用したSupabaseクライアント
- `app/api/lectures/[id]/end/route.ts` - 手動終了API（参考）
- `README.md` - PRD（機能要件の詳細）

